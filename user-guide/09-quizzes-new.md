# Quizzes & Question Banks

## Overview

Zaphod treats **quizzes as first-class content** alongside pages and assignments, while maintaining **reusable question banks** as a separate concern. This two-tier architecture enables:

- **Question banks** to be stored as discrete, named, version-controlled pools
- **Quiz instances** that reference banks with subsetting and per-student randomization
- **Full Canvas Quiz integration** (Classic Quizzes via QTI for banks, native API for quiz instances)

---

## Architecture

### Two-Layer Model

```
quiz-banks/*-bank.md  →  [sync_banks.py]  →  Canvas Question Banks
                                                       ↓
pages/*.quiz/index.md  →  [sync_quizzes.py]  →  Canvas Quizzes (reference banks)
```

**Layer 1: Question Banks** (`quiz-banks/*-bank.md`)
- Plain-text NYIT-format questions with YAML frontmatter
- Converted to QTI packages and uploaded to Canvas
- Creates **named, discrete banks** that can be reused across multiple quizzes
- Banks are **never directly assigned** to students

**Layer 2: Quiz Instances** (`pages/*.quiz/`)
- First-class content in `pages/` directory (like `.page`, `.assignment`)
- Structured `index.md` with frontmatter defining quiz settings
- References question banks by name
- Supports **subsetting** (pull N questions) and **randomization** (different per student)
- Published as Canvas Quizzes that students actually take

---

## Question Banks

### Bank File Structure

Question banks live in `quiz-banks/` with `-bank.md` extension:

```
course-repo/
└── quiz-banks/
    ├── chapter-1-basics-bank.md
    ├── chapter-2-advanced-bank.md
    └── midterm-pool-bank.md
```

### NYIT Format Specification

Each `*-bank.md` file uses NYIT plain-text format with YAML frontmatter:

```
---
bank_name: "Chapter 1: Python Basics"
description: "Core Python concepts - variables, types, control flow"
---

1. What is the output of `print(type(42))`?
*a) <class 'int'>
b) <class 'float'>
c) <class 'str'>
d) 42

2. Which keyword is used to define a function in Python?
a) function
*b) def
c) func
d) define

3. True or False: Python uses indentation to define code blocks.
*a) True
b) False

4. Explain the difference between a list and a tuple in Python. [essay]

5. Write a Python function that returns the sum of two numbers. [code]
```

### Question Types Supported

| Type | Syntax | Canvas Equivalent |
|------|--------|-------------------|
| **Multiple Choice** | Answers with `*` prefix for correct | Multiple Choice |
| **Multiple Answer** | Multiple `*` prefixes | Multiple Answers |
| **True/False** | Two options, one with `*` | True/False |
| **Essay** | `####` suffix | Essay Question |
| **Short Answer** | `[short]` suffix | Short Answer |
| **File Upload** | `^^^^` suffix | File Upload Question |
| **Code** | `[code]` suffix | Essay (Canvas doesn't have code type) |

### Bank Frontmatter

```yaml
---
bank_name: "Required - displayed name in Canvas"
description: "Optional - bank description"
---
```

- **`bank_name`**: Required. The display name for the question bank in Canvas
- **`description`**: Optional. Metadata shown in Canvas bank details

### Syncing Banks to Canvas

```bash
# Sync all banks
zaphod sync --banks-only

# Or as part of full sync
zaphod sync
```

**What happens:**
1. `sync_banks.py` reads all `quiz-banks/*-bank.md` files
2. Parses NYIT format into questions
3. Converts to QTI 1.2 package format
4. Uploads QTI to Canvas via import API
5. Canvas creates/updates named question banks
6. Questions become available for quiz instances

**Key behaviors:**
- Banks are **identified by name** (not filename)
- Re-running sync **updates existing banks** (adds new questions, keeps old ones)
- Empty banks (zero questions) are flagged but not auto-deleted
- Bank questions are **never directly graded** (they're templates for quiz questions)

---

## Quiz Instances

### Quiz Directory Structure

Quizzes live in `pages/` as first-class content with `.quiz` suffix:

```
pages/
└── week-3-python-fundamentals.quiz/
    ├── index.md          # Quiz configuration and instructions
    └── meta.json         # Generated by frontmatter_to_meta.py
```

### Quiz Frontmatter

```yaml
---
title: "Week 3: Python Fundamentals Quiz"
type: quiz
modules: ["Week 3"]

# Quiz settings
quiz_type: "assignment"        # assignment | practice_quiz | graded_survey | survey
time_limit: 30                 # minutes
allowed_attempts: 2
shuffle_answers: true
show_correct_answers: true
show_correct_answers_after: "2026-02-15T23:59:00"

# Question sources
banks:
  - name: "chapter-1-basics"
    count: 10
    randomize: true
  - name: "chapter-2-advanced"
    count: 5
    randomize: true

# Points and grading
points_possible: 15
assignment_group: "Quizzes"
***

## Instructions

This quiz covers Python fundamentals from Weeks 1-2. You have 30 minutes and 2 attempts.

**Topics covered:**
- Variables and data types
- Control flow (if/else, loops)
- Functions and scope
- Basic data structures

Good luck!
```

### Frontmatter Fields

#### Required Fields

- **`title`**: Quiz display name in Canvas
- **`type`**: Must be `quiz`
- **`banks`**: Array of bank references (see below)

#### Quiz Behavior

- **`quiz_type`**: `assignment` (default), `practice_quiz`, `graded_survey`, `survey`
- **`time_limit`**: Minutes allowed (null = untimed)
- **`allowed_attempts`**: Number of attempts (-1 = unlimited)
- **`shuffle_answers`**: Randomize answer order (true/false)
- **`show_correct_answers`**: Show answers after submission (true/false)
- **`show_correct_answers_after`**: ISO timestamp to reveal answers

#### Grading

- **`points_possible`**: Total points (distributed across questions)
- **`assignment_group`**: Assignment group name (auto-created if missing)
- **`due_at`**: ISO timestamp for due date
- **`lock_at`**: ISO timestamp when quiz locks
- **`unlock_at`**: ISO timestamp when quiz unlocks

#### Organization

- **`modules`**: Array of module names (same as pages/assignments)
- **`published`**: `true` (default) or `false`

### Bank References with Subsetting

The `banks` array defines which question banks to pull from:

```yaml
banks:
  - name: "chapter-1-basics"      # Bank name (must match bank_name in -bank.md)
    count: 10                      # Number of questions to include
    randomize: true                # Each student gets different questions
  
  - name: "chapter-2-advanced"
    count: 5
    randomize: false               # All students get same questions
```

#### Bank Reference Fields

- **`name`** (required): Exact match to `bank_name` in question bank
- **`count`** (required): How many questions to pull from bank
- **`randomize`** (optional, default `false`): Whether to randomize per student

#### Randomization Behavior

When `randomize: true`:
- **Each student** sees a different random subset of `count` questions
- Questions are selected when student **starts the quiz**
- Promotes academic integrity (different questions = harder to cheat)
- Requires bank to have **at least `count` questions** (Zaphod validates this)

When `randomize: false`:
- All students see the **same questions** from the bank
- Questions are the **first `count`** from the bank (deterministic)
- Use for small banks or when everyone must answer identical questions

### Quiz Body (Markdown)

The body of `index.md` becomes the **quiz instructions** in Canvas:

```markdown
---
title: "Midterm Exam"
type: quiz
# ... frontmatter ...
---

## Midterm Instructions

This exam covers all material from Weeks 1-7.

**Exam rules:**
- Open book, open notes
- No collaboration with other students
- You have 90 minutes
- 1 attempt only

Contact instructor if technical issues arise. Good luck!
```

- Rendered as **HTML** and displayed at top of quiz
- Supports all markdown features (headings, lists, bold, links, etc.)
- **No `{{video:...}}` or asset hydration** (quizzes don't support embedded media in instructions)

### Syncing Quizzes to Canvas

```bash
# Sync all quizzes
zaphod sync --quizzes-only

# Or as part of full sync
zaphod sync
```

**What happens:**
1. `frontmatter_to_meta.py` processes `pages/*.quiz/index.md` → `meta.json` + `source.md`
2. `sync_quizzes.py` reads quiz metadata
3. Validates bank references (checks banks exist, have enough questions)
4. Creates/updates Canvas Quiz via API
5. Links quiz questions to question banks (via Canvas quiz groups)
6. `sync_modules.py` adds quiz to specified modules

**Key behaviors:**
- Quizzes are **created if missing**, **updated if changed**
- Bank questions are **copied into quiz** (quiz has its own question instances)
- Changes to **quiz settings** (time limit, attempts) update immediately
- Changes to **bank questions** require **re-syncing the bank** first

---

## Workflow Examples

### Example 1: Creating a Simple Quiz

**Step 1:** Create question bank

```bash
# quiz-banks/week-1-bank.md
---
bank_name: "Week 1: Getting Started"
---

1. What does HTML stand for?
*a) HyperText Markup Language
b) High-Tech Modern Language
c) Home Tool Markup Language

2. True or False: CSS is used for page layout and styling.
*a) True
b) False
```

**Step 2:** Create quiz instance

```bash
# pages/week-1-quiz.quiz/index.md
---
title: "Week 1 Quiz"
type: quiz
modules: ["Week 1"]
time_limit: 15
banks:
  - name: "Week 1: Getting Started"
    count: 2
    randomize: false
points_possible: 2
---

Quick quiz on Week 1 concepts. 15 minutes, all questions required.
```

**Step 3:** Sync to Canvas

```bash
zaphod sync
```

Result: Canvas has a "Week 1: Getting Started" question bank with 2 questions, and a "Week 1 Quiz" that uses both questions.

---

### Example 2: Large Question Pool with Randomization

**Use case:** 50-question bank, each student gets 10 random questions

**Step 1:** Build comprehensive bank

```bash
# quiz-banks/python-fundamentals-pool-bank.md
---
bank_name: "Python Fundamentals - Large Pool"
description: "50 questions covering variables, types, control flow, functions"
---

1. What is the output of `print(3 ** 2)`?
*a) 9
b) 6
c) 5
d) 8

2. Which operator checks for equality in Python?
a) =
*b) ==
c) ===
d) equals

# ... (48 more questions) ...
```

**Step 2:** Create randomized quiz

```bash
# pages/midterm.quiz/index.md
---
title: "Python Midterm"
type: quiz
modules: ["Midterm"]
time_limit: 60
allowed_attempts: 1
banks:
  - name: "Python Fundamentals - Large Pool"
    count: 10
    randomize: true    # ← Key: different 10 per student
points_possible: 10
---

## Midterm Exam

Each student receives 10 random questions from the fundamentals pool.
```

**Step 3:** Sync

```bash
zaphod sync
```

Result: Bank has 50 questions. Each student sees 10 different random questions when they start the quiz. Student A might get questions 3, 7, 12, 18, 23, 29, 35, 41, 46, 50. Student B gets a different set.

---

### Example 3: Multi-Bank Quiz

**Use case:** Final exam pulling from multiple chapter banks

```yaml
---
title: "Final Exam"
type: quiz
time_limit: 120
allowed_attempts: 1

banks:
  - name: "Chapter 1: Basics"
    count: 5
    randomize: true
  
  - name: "Chapter 2: Functions"
    count: 5
    randomize: true
  
  - name: "Chapter 3: Data Structures"
    count: 5
    randomize: true
  
  - name: "Chapter 4: OOP"
    count: 5
    randomize: true

points_possible: 20
---

Comprehensive final covering all 4 chapters. 5 random questions per chapter.
```

Result: Each student gets 20 questions total (5 from each chapter bank, all randomized independently).

---

## Maintenance and Cleanup

### Pruning Orphaned Banks and Empty Quizzes

```bash
zaphod prune --quizzes
```

**What gets deleted:**

1. **Question banks** whose name doesn't match any current `quiz-banks/*-bank.md` file's `bank_name`
2. **Classic quizzes** with zero questions (likely from failed imports)

**What's preserved:**

- Banks referenced by active quiz instances (checked via `banks[].name` in quiz frontmatter)
- Quizzes with at least 1 question
- New Quizzes (not managed by Zaphod)

**Safety:**
- Dry-run mode shows what would be deleted
- Banks in use by quizzes are never deleted (even if `-bank.md` is gone)

### Validation

```bash
zaphod validate
```

Checks for quiz-specific issues:

- ✅ All `banks[].name` references exist in `quiz-banks/`
- ✅ Each bank has >= `count` questions for non-randomized quizzes
- ✅ Randomized quizzes have sufficient pool size
- ✅ Quiz frontmatter has required fields (`title`, `type`, `banks`)
- ✅ `points_possible` is set and positive

---

## Advanced Topics

### Question Weighting

Canvas distributes `points_possible` evenly across all questions. For custom weighting:

```yaml
banks:
  - name: "Easy Questions"
    count: 10
  - name: "Hard Questions"
    count: 5

points_possible: 20  # Easy = 1pt each, Hard = 2pts each
```

Zaphod does **not** support per-question point values in frontmatter. Use Canvas UI for manual weighting after sync.

### Question Groups in Canvas

Zaphod uses Canvas **Question Groups** (linked to question banks) to implement randomization:

- Each `banks[]` entry → one Canvas Question Group
- `randomize: true` → "Pick N questions randomly"
- `randomize: false` → "Pick first N questions"

View in Canvas: Edit Quiz → Questions tab → see "[Group] Chapter 1: 10 questions"

### Updating Banks Without Re-Syncing Quizzes

**Scenario:** You add 10 new questions to `chapter-1-bank.md`. Do existing quizzes get the new questions?

**Answer:** No, not automatically.

**Why:** Canvas copies questions from banks into quizzes at creation time. The quiz has **its own question instances**, not live references.

**To update:**
1. Sync the bank: `zaphod sync --banks-only`
2. Manually update quiz in Canvas UI, or
3. Re-sync the quiz: `zaphod sync --quizzes-only` (recreates quiz questions)

### Migration from Old `sync_quiz_banks.py`

**Old model (deprecated):**
- `quiz-banks/*-bank.md` → monolithic quiz (one file = one quiz with embedded questions)

**New model:**
- `quiz-banks/*-bank.md` → reusable question bank
- `pages/*.quiz/index.md` → quiz instance referencing banks

**Migration steps:**

1. **Keep your `-bank.md` files** in `quiz-banks/` (they become question banks)
2. Add `bank_name:` to frontmatter if missing
3. **Create new quiz instances** in `pages/*.quiz/index.md` that reference the banks:
   ```yaml
   banks:
     - name: "Your Bank Name"
       count: 10  # or however many questions are in the bank
       randomize: false
   ```
4. Run `zaphod sync` (creates banks + quiz instances)
5. Delete old monolithic quizzes in Canvas if desired

---

## Common Patterns

### Pattern: Weekly Quizzes with Shared Pool

**Setup:**
- One large question bank per module
- Each week's quiz pulls random subset

```
quiz-banks/
├── module-1-pool-bank.md    # 30 questions
├── module-2-pool-bank.md    # 30 questions
└── module-3-pool-bank.md    # 30 questions

pages/
├── week-1-quiz.quiz/index.md   # pulls 5 from module-1-pool
├── week-2-quiz.quiz/index.md   # pulls 5 from module-1-pool (different 5)
├── week-3-quiz.quiz/index.md   # pulls 5 from module-1-pool
└── ...
```

### Pattern: Cumulative Exams

**Setup:**
- Separate bank per chapter
- Midterm pulls from chapters 1-4
- Final pulls from chapters 1-8

```yaml
# pages/midterm.quiz/index.md
banks:
  - name: "Chapter 1"
    count: 3
  - name: "Chapter 2"
    count: 3
  - name: "Chapter 3"
    count: 3
  - name: "Chapter 4"
    count: 3
# 12 questions total

# pages/final.quiz/index.md
banks:
  - name: "Chapter 1"
    count: 2
  - name: "Chapter 2"
    count: 2
  # ... chapters 3-7 ...
  - name: "Chapter 8"
    count: 2
# 16 questions total
```

### Pattern: Practice vs Graded Quiz

**Setup:**
- Same question bank
- Two quiz instances (practice + graded)

```yaml
# pages/practice-quiz-1.quiz/index.md
---
title: "Practice Quiz 1"
quiz_type: practice_quiz
allowed_attempts: -1        # unlimited
show_correct_answers: true  # immediate feedback
banks:
  - name: "Chapter 1"
    count: 10
    randomize: true
---

# pages/graded-quiz-1.quiz/index.md
---
title: "Graded Quiz 1"
quiz_type: assignment
allowed_attempts: 1
show_correct_answers: true
show_correct_answers_after: "2026-02-15T23:59:00"  # after due date
banks:
  - name: "Chapter 1"
    count: 10
    randomize: true
points_possible: 10
---
```

---

## Troubleshooting

### "Bank not found" error

**Error:** `QuizValidationError: Bank 'Chapter 1' referenced in quiz 'Week 1 Quiz' does not exist`

**Cause:** Quiz references a bank name that doesn't match any `-bank.md` file's `bank_name` frontmatter.

**Fix:**
1. Check `quiz-banks/*-bank.md` frontmatter: is `bank_name: "Chapter 1"` set?
2. Check spelling/capitalization (must match exactly)
3. Run `zaphod sync --banks-only` first to ensure banks exist in Canvas

### "Insufficient questions in bank" error

**Error:** `QuizValidationError: Bank 'Python Basics' has only 5 questions, but quiz requests 10`

**Cause:** Quiz asks for more questions than exist in the bank.

**Fix:**
1. Reduce `count` in quiz frontmatter, or
2. Add more questions to the `-bank.md` file

### Quiz questions don't update after editing bank

**Cause:** Canvas quizzes have **copied question instances**, not live links to banks.

**Fix:**
1. Sync the bank: `zaphod sync --banks-only`
2. Re-sync the quiz to pull new questions: `zaphod sync --quizzes-only`
3. Or manually update quiz in Canvas UI (Questions tab → Update Group)

### Randomization not working

**Symptoms:** All students see the same questions despite `randomize: true`

**Cause:** Canvas caches question selection when student **opens** the quiz. If you toggle `randomize` after students started, they keep their original questions.

**Fix:**
- Delete student submissions (if practice quiz)
- Re-sync quiz **before** students start
- Use Canvas "Moderate Quiz" to reset attempts if needed

### Bank uploaded but not visible in Canvas

**Cause:** QTI import may be processing asynchronously.

**Fix:**
1. Check Canvas account → Settings → Import Queue (may take 30-60 seconds)
2. If import failed, check Canvas error log
3. Validate `-bank.md` format (common issues: missing `*` for correct answers, malformed YAML frontmatter)

---

## Implementation Notes

### Canvas API Limitations

- **Classic Quizzes only**: Zaphod uses Canvas Classic Quizzes (not New Quizzes)
- **QTI 1.2 for banks**: Question banks require QTI import (no native create-bank API)
- **No partial updates**: Changing quiz questions requires recreating the quiz group

### File Watching

In watch mode (`zaphod sync --watch`):
- Changes to `quiz-banks/*-bank.md` → trigger bank sync
- Changes to `pages/*.quiz/index.md` → trigger quiz sync
- Incremental mode: only affected banks/quizzes are re-synced

### Caching

- **Bank metadata** cached in `_course_metadata/quiz_banks.json`
- **Quiz state** cached per quiz in `pages/*.quiz/meta.json`
- Cache invalidated when source files change (detected via mtime)

---

## Related Documentation

- **[01-ARCHITECTURE.md](./01-ARCHITECTURE.md)**: Pipeline overview and incremental processing
- **[03-GLOSSARY.md](./03-GLOSSARY.md)**: Content types (`.page`, `.assignment`, `.quiz`)
- **[05-QUICK-START.md](./05-QUICK-START.md)**: `zaphod sync` command reference
- **[Canvas Classic Quizzes](https://community.canvaslms.com/t5/Instructor-Guide/How-do-I-create-a-quiz-using-classic-quizzes/ta-p/1093)**: Canvas documentation for quiz features
- **[QTI 1.2 Specification](https://www.imsglobal.org/question/qtiv1p2/imsqti_asi_infov1p2.html)**: Question and Test Interoperability format

---

## Glossary Additions

**Question Bank**: A reusable pool of questions stored in Canvas, created from `quiz-banks/*-bank.md` files. Banks are never directly assigned to students; they serve as sources for quiz instances.

**Quiz Instance**: A first-class content item in `pages/*.quiz/` that references question banks, defines quiz settings (time limit, attempts), and is published as a Canvas Quiz that students actually take.

**Bank Reference**: An entry in a quiz's `banks` frontmatter array that specifies which question bank to pull from, how many questions to include, and whether to randomize per student.

**Subsetting**: The act of pulling a specified number (`count`) of questions from a larger question bank. Enables large banks (50 questions) to serve small quizzes (10 questions).

**Per-Student Randomization**: When `randomize: true`, each student receives a different random subset of questions from the bank at quiz-start time. Promotes academic integrity by making it harder to share answers.

**NYIT Format**: Plain-text quiz question format with YAML frontmatter and markdown-style questions. Supports multiple choice, true/false, essay, and other Canvas question types. Correct answers marked with `*` prefix.

**QTI (Question & Test Interoperability)**: IMS Global standard for representing questions and quizzes. Zaphod converts NYIT format to QTI 1.2 packages for Canvas import, as Canvas has no native API to create question banks.